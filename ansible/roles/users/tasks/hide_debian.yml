---

- name: set User part in AccountServices configuration
  become: yes
  lineinfile:
    backup:      no
    create:      yes
    dest:        "/var/lib/AccountsService/users/{{ user }}"
    group:       root
    insertafter: EOF
    line:        "[User]"
    owner:       root
    state:       present
  with_items: "{{ users }}"
  loop_control:
    loop_var: user

- name: show/hide user's name at login (AccountsService)
  become: yes
  lineinfile:
    backup:      no
    create:      yes
    dest:        "/var/lib/AccountsService/users/{{ user }}"
    group:       root
    insertafter: !unsafe "^\\[User\\]$"
    line:        "SystemAccount=true"
    regexp:      "^SystemAccount=.*$"
    owner:       root
    state:       present
  with_items: "{{ hidden_users }}"
  loop_control:
    loop_var: user

...