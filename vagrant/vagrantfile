Vagrant.configure('2') { |config|

  machines = [
      {:name => 'testnode', :ip => '10.0.4.101', :port => 22221},
  ]

  private_key = '../ssh-keys/id_rsa'
  public_key = '../ssh-keys/id_rsa.pub'

  machines.each { |machine|

    config.vm.define machine[:name] { |node|
      # add keys
      node.ssh.forward_agent = true
      node.ssh.keys_only = false
      node.ssh.insert_key = false
      node.ssh.private_key_path = [
          '~/.vagrant.d/insecure_private_key',
          private_key
      ]
      node.vm.provision 'file' do |f|
        f.source = public_key
        f.destination = '~/.ssh/authorized_keys'
      end
      node.vm.provision 'file' do |f|
        f.source = private_key
        f.destination = '~/.ssh/id_rsa'
      end

      # set machine provider
      node.vm.provider "virtualbox" do |v|
        v.gui = true
        v.name = machine[:name]
        v.memory = 4096
        v.cpus = 1
      end

      # create machine
      node.vm.box = 'boxcutter/ubuntu1604-desktop'
      node.vm.hostname = machine[:name]
      node.vm.network 'private_network',
                      ip: machine[:ip]
      node.vm.network 'forwarded_port',
                      id: 'ssh',
                      guest: 22,
                      host: machine[:port]

      # install python
      machines.each { |other|
        node.vm.provision 'shell' do |s|
          s.inline = 'sudo apt-get -y install python'
          s.args = [other[:ip], other[:name]]
        end
      }

    }

  }

}